#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <PZEM004Tv30.h>
#include <HardwareSerial.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>

void sendSMS();

// --------------------------------------
// LCD
// --------------------------------------
LiquidCrystal_I2C lcd(0x27, 16, 2);

// --------------------------------------
// PZEM
// --------------------------------------
HardwareSerial PZEMSerial(2);
PZEM004Tv30 pzem(PZEMSerial, 17, 16);

// --------------------------------------
// WiFi + MQTT
// --------------------------------------
const char* ssid = "Yourssid";
const char* password = "Password";

unsigned long lastSMS = 0; // timestamp of last SMS sent
const unsigned long smsCooldown = 60000; // 1 minute in milliseconds


const char* mqtt_server = "broker.hivemq.com"; 
const int   mqtt_port   = 1883;

const char* apiKey = "xthTmyPm9ynQ";    
const char* deviceID = "ESP-32_Tracker";
const char* templateID = "101";
const char* mobileNumber = "Yourphonenumber";

WiFiClient espClient;
PubSubClient client(espClient);

// MQTT topics
const char* tV  = "unique/energy/voltage";
const char* tI  = "unique/energy/current";
const char* tP  = "unique/energy/power";
const char* tE  = "unique/energy/energy";
const char* tF  = "unique/energy/frequency";
const char* tPF = "unique/energy/pf";
const char* tJSON = "unique/energy/data";

// --------------------------------------
// WiFi connect
// --------------------------------------
void setup_wifi() {
  Serial.print("[WiFi] Connecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  int retry = 0;

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    retry++;
    if (retry > 40) {
      Serial.println("\n[WiFi] Failed.");
      return;
    }
  }

  Serial.println("\n[WiFi] Connected!");
  Serial.print("[WiFi] IP: ");
  Serial.println(WiFi.localIP());
}

// --------------------------------------
// MQTT reconnect
// --------------------------------------
void reconnect() {
  while (!client.connected()) {
    Serial.print("[MQTT] Connecting...");
    String cid = "ESP32-" + String(random(1000, 9999));

    if (client.connect(cid.c_str())) {
      Serial.println("OK");
    } else {
      Serial.print("Fail rc=");
      Serial.println(client.state());
      delay(2000);
    }
  }
}

// --------------------------------------
// SEND SMS FUNCTION
// --------------------------------------
void sendSMS() {

  Serial.println("üì® SMS FUNCTION CALLED");

  WiFiClientSecure secureClient;    // FIXED
  secureClient.setInsecure();       

  HTTPClient http;

  String apiUrl = "https://www.circuitdigest.cloud/send_sms?ID=" + String(templateID);
  http.begin(secureClient, apiUrl);

  http.addHeader("Authorization", apiKey);
  http.addHeader("Content-Type", "application/json");

 String payload =
  "{\"mobiles\":\"" + String(mobileNumber) +
  "\",\"var1\":\"Energy meter\"" +
  ",\"var2\":\"High Voltage\"}";

  Serial.println(payload);

  int code = http.POST(payload);
  Serial.print("HTTP Response Code: ");
  Serial.println(code);

  String response = http.getString();
  Serial.println(response);

  http.end();
}

// --------------------------------------
// SETUP
// --------------------------------------
void setup() {
  Serial.begin(115200);

  Wire.begin(21, 22);
  lcd.init();
  lcd.backlight();

  lcd.setCursor(0, 0); lcd.print("Energy Monitor");
  lcd.setCursor(0, 1); lcd.print("Starting...");
  delay(2000);

  PZEMSerial.begin(9600);

  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
}

// --------------------------------------
// LOOP
// --------------------------------------
void loop() {

  if (!client.connected()) reconnect();
  client.loop();

  float V = pzem.voltage();
  float I = pzem.current();
  float P = pzem.power();
  float E = pzem.energy();
  float F = pzem.frequency();
  float PF = pzem.pf();



  // =====================================================
  //         High Voltage(FIXED)
  // =====================================================
  // === ZERO CURRENT ALERT ===
if (V > 255) {   
    if (millis() - lastSMS > smsCooldown) {
        Serial.println("‚ö†Ô∏è High Voltage Detected");
        sendSMS();
        lastSMS = millis();  // update timestamp
    }
}

if (isnan(V) || V < 10.0) {
  Serial.println("Mains appears OFF -> forcing zeros");

  I = 0.0;
  P = 0.0;
  E = 0.0;
  F=0.0;
  PF=0.00;

  // Optionally: publish zeros to MQTT and update LCD here

} else {
  // Normal publishing and LCD display
}
  Serial.printf("[Data] V: %.1f  I: %.3f  P: %.1f  E: %.3f  F: %.1f  PF: %.2f\n",
                V, I, P, E, F, PF);
  // -------- MQTT PUBLISH ----------
  client.publish(tV,  String(V, 1).c_str(), true);
  client.publish(tI,  String(I, 3).c_str(), true);
  client.publish(tP,  String(P, 1).c_str(), true);
  client.publish(tE,  String(E, 3).c_str(), true);
  client.publish(tF,  String(F, 1).c_str(), true);
  client.publish(tPF, String(PF, 2).c_str(), true);

  String json = "{";
  json += "\"V\":" + String(V, 1) + ",";
  json += "\"I\":" + String(I, 3) + ",";
  json += "\"P\":" + String(P, 1) + ",";
  json += "\"E\":" + String(E, 3) + ",";
  json += "\"F\":" + String(F, 1) + ",";
  json += "\"PF\":" + String(PF, 2);
  json += "}";
  client.publish(tJSON, json.c_str(), true);

  // -------- LCD DISPLAY ----------
  lcd.clear(); lcd.setCursor(0,0);
  lcd.print("Volt:"); lcd.print(V,1); lcd.print("V");
  delay(2000);

  lcd.clear(); lcd.setCursor(0,0);
  lcd.print("Curr:"); lcd.print(I,3); lcd.print("A");
  delay(2000);

  lcd.clear(); lcd.setCursor(0,0);
  lcd.print("Power:"); lcd.print(P,1); lcd.print("W");
  delay(2000);

  lcd.clear(); lcd.setCursor(0,0);
  lcd.print("Energy:"); lcd.print(E,3); lcd.print("kWh");
  delay(2000);

  lcd.clear(); lcd.setCursor(0,0);
  lcd.print("Freq:"); lcd.print(F,1); lcd.print("Hz");
  delay(2000);

  lcd.clear(); lcd.setCursor(0,0);
  lcd.print("PF:"); lcd.print(PF,2);
  delay(2000);
}
